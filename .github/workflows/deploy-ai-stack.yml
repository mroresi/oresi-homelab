name: Deploy AI Stack

on:
  push:
    branches: [main]
    paths:
      - "stacks/stack-ai/**"
      - "chatops/intents/rollout_stack_ai.yaml"
      - "chatops/intents/scale_stack_ai.yaml"

  workflow_dispatch:
    inputs:
      intent:
        description: "Intent to execute"
        required: true
        default: "rollout_stack_ai"
        type: choice
        options:
          - rollout_stack_ai
          - scale_stack_ai

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate stack configuration
        run: |
          # Skip validation on manual dispatch (stacks may live outside this repo)
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "â„¹ï¸  Skipping stack validation on manual dispatch"
            exit 0
          fi

          if [ ! -f "stacks/stack-ai/docker-compose.yml" ]; then
            echo "âŒ docker-compose.yml not found"
            exit 1
          fi

          # Basic YAML syntax check
          python3 -c "import yaml; yaml.safe_load(open('stacks/stack-ai/docker-compose.yml'))"
          echo "âœ… Stack configuration is valid"

      - name: Check GPU requirements
        run: |
          echo "ðŸ” Checking AI stack GPU requirements..."
          if grep -q "runtime: nvidia" stacks/stack-ai/docker-compose.yml; then
            echo "âœ… NVIDIA runtime configured"
          fi

          if grep -q "device_ids" stacks/stack-ai/docker-compose.yml; then
            echo "âœ… GPU device IDs specified"
          fi

  deploy:
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Verify Tailscale credentials presence
        env:
          TS_OAUTH_CLIENT_ID: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          TS_OAUTH_CLIENT_SECRET: ${{ secrets.TS_OAUTH_CLIENT_SECRET }}
          TAILSCALE_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
        run: |
          have_oauth=0
          if [ -n "$TS_OAUTH_CLIENT_ID" ] && [ -n "$TS_OAUTH_CLIENT_SECRET" ]; then have_oauth=1; fi
          have_authkey=0
          if [ -n "$TAILSCALE_AUTHKEY" ]; then have_authkey=1; fi

          if [ $have_oauth -eq 0 ] && [ $have_authkey -eq 0 ]; then
            echo "âŒ No Tailscale credentials provided. Configure either:\n- TS_OAUTH_CLIENT_ID and TS_OAUTH_CLIENT_SECRET (recommended)\n- or TAILSCALE_AUTHKEY (fallback)" >&2
            exit 1
          fi
          if [ $have_oauth -eq 1 ]; then echo "âœ… OAuth client detected"; fi
          if [ $have_authkey -eq 1 ]; then echo "âœ… Auth key detected (fallback available)"; fi

      - name: Detect Tailscale credentials
        id: tscreds
        env:
          TS_ID: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          TS_SECRET: ${{ secrets.TS_OAUTH_CLIENT_SECRET }}
          TS_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
        run: |
          have_oauth=0
          if [ -n "$TS_ID" ] && [ -n "$TS_SECRET" ]; then have_oauth=1; fi
          have_authkey=0
          if [ -n "$TS_AUTHKEY" ]; then have_authkey=1; fi
          echo "have_oauth=$have_oauth" >> $GITHUB_OUTPUT
          echo "have_authkey=$have_authkey" >> $GITHUB_OUTPUT

      - name: Install Tailscale (OAuth)
        if: ${{ steps.tscreds.outputs.have_oauth == '1' }}
        id: tsoauth
        continue-on-error: true
        uses: tailscale/github-action@v2
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_CLIENT_SECRET }}

      - name: Install Tailscale (Authkey fallback)
        if: ${{ (steps.tscreds.outputs.have_oauth != '1' && steps.tscreds.outputs.have_authkey == '1') || (steps.tsoauth.outcome == 'failure' && steps.tscreds.outputs.have_authkey == '1') }}
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TAILSCALE_AUTHKEY }}

      - name: Require Tailscale credentials
        if: ${{ (steps.tscreds.outputs.have_oauth != '1' && steps.tscreds.outputs.have_authkey != '1') || (steps.tsoauth.outcome == 'failure' && steps.tscreds.outputs.have_authkey != '1') }}
        run: |
          echo "âŒ Missing Tailscale credentials. Configure either:\n- TS_OAUTH_CLIENT_ID and TS_OAUTH_CLIENT_SECRET (recommended)\n- or TAILSCALE_AUTHKEY (fallback)" >&2
          exit 1

      - name: Wait for Tailscale connection
        run: |
          echo "Waiting for Tailscale mesh connection..."
          timeout=30
          elapsed=0

          until tailscale status | grep -q "whitebox"; do
            if [ $elapsed -ge $timeout ]; then
              echo "âŒ Timeout waiting for Tailscale connection"
              tailscale status
              exit 1
            fi
            echo "Waiting... ($elapsed/$timeout seconds)"
            sleep 2
            elapsed=$((elapsed + 2))
          done

          echo "âœ… Tailscale connected"
          tailscale status

      - name: Health check ChatOps service
        run: |
          if ! curl -fsS --connect-timeout 10 http://whitebox.bombay-porgy.ts.net:8000/healthz; then
            echo "âŒ ChatOps service is not healthy"
            exit 1
          fi
          echo "âœ… ChatOps service is healthy"

      - name: Determine intent
        id: intent
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            INTENT="${{ github.event.inputs.intent }}"
          else
            INTENT="rollout_stack_ai"
          fi
          echo "intent=$INTENT" >> $GITHUB_OUTPUT
          echo "ðŸ“‹ Will execute intent: $INTENT"

      - name: Pre-deploy GPU check
        run: |
          echo "ðŸŽ® Verifying GPU availability on target node..."
          # Note: This would require SSH access or API call to Proxmox
          echo "âš ï¸  Manual verification recommended for GPU passthrough"

      - name: Trigger ChatOps deployment
        id: deploy
        env:
          CHATOPS_API_KEY: ${{ secrets.CHATOPS_API_KEY }}
        run: |
          INTENT="${{ steps.intent.outputs.intent }}"

          echo "ðŸš€ Triggering ChatOps: $INTENT"

          response=$(curl -X POST http://whitebox.bombay-porgy.ts.net:8000/run \
            -H "X-API-Key: $CHATOPS_API_KEY" \
            -H "Content-Type: application/json" \
            -d "{\"name\": \"$INTENT\"}" \
            -w "\n%{http_code}" \
            -s -o response.json)

          http_code=$(echo "$response" | tail -n1)

          echo "ðŸ“Š HTTP Status: $http_code"

          if [ -f response.json ]; then
            echo "ðŸ“„ Response:"
            cat response.json | jq . || cat response.json
          fi

          if [ "$http_code" -ne 200 ]; then
            echo "âŒ ChatOps deployment failed with status $http_code"
            exit 1
          fi

          echo "âœ… ChatOps deployment triggered successfully"

      - name: Wait for AI services stabilization
        run: |
          echo "â³ Waiting 60 seconds for AI containers to stabilize (model loading)..."
          sleep 60

      - name: Post-deploy validation
        run: |
          echo "ðŸ” Validating deployed AI services..."

          # Check Ollama API
          if ! curl -fsS --connect-timeout 10 http://192.168.0.102:11434/api/tags > /dev/null 2>&1; then
            echo "âš ï¸  Ollama API check failed (may still be loading models)"
          else
            echo "âœ… Ollama is responding"
            curl -s http://192.168.0.102:11434/api/tags | jq '.models[].name' || true
          fi

          # Check GPU utilization (if nvidia-smi accessible)
          echo "ðŸ“Š Note: Check GPU utilization via Proxmox console or nvidia-smi"

          echo "âœ… Post-deploy validation complete"
          echo "ðŸ“Š Verify via monitoring dashboards"

      - name: Notify success
        if: success()
        run: |
          echo "ðŸŽ‰ AI Stack deployment successful!"
          echo "Stack: stack-ai"
          echo "Intent: ${{ steps.intent.outputs.intent }}"
          echo "Commit: ${{ github.sha }}"
          echo "Triggered by: ${{ github.actor }}"
          echo ""
          echo "ðŸ“ Post-deployment checklist:"
          echo "- [ ] Verify Ollama responds at :11434"
          echo "- [ ] Check GPU passthrough working (nvidia-smi)"
          echo "- [ ] Test model inference"
          echo "- [ ] Verify disk usage under threshold"

      - name: Notify failure
        if: failure()
        run: |
          echo "âŒ AI Stack deployment failed!"
          echo "Check logs above for details"
          echo "Common issues:"
          echo "- GPU passthrough not configured"
          echo "- Insufficient VRAM"
          echo "- Model files missing"
          echo "- NFS mount issues (/srv/ai_data)"

  notify-discord:
    needs: [validate, deploy]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Send Discord notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_DEPLOYMENT_WEBHOOK }}
        run: |
          if [ -z "$DISCORD_WEBHOOK" ]; then
            echo "â„¹ï¸  Discord webhook not configured, skipping notification"
            exit 0
          fi

          if [ "${{ needs.deploy.result }}" = "success" ]; then
            COLOR=5814783  # Purple (AI theme)
            TITLE="ðŸ¤– AI Stack Deployed"
            DESC="Successfully deployed stack-ai with GPU support"
          else
            COLOR=15158332  # Red
            TITLE="âŒ AI Stack Deployment Failed"
            DESC="Deployment failed. Check GitHub Actions logs for details."
          fi

          COMMIT="\`${{ github.sha }}\`"
          ACTOR="${{ github.actor }}"
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          # Build payload with jq to avoid YAML parsing confusion
          jq -n \
            --arg title "$TITLE" \
            --arg desc "$DESC" \
            --arg commit "$COMMIT" \
            --arg actor "$ACTOR" \
            --arg url "$RUN_URL" \
            --arg services "Ollama, OpenWebUI, Stable Diffusion" \
            --argjson color "$COLOR" \
            '{
              embeds: [
                {
                  title: $title,
                  description: $desc,
                  color: $color,
                  fields: [
                    {name: "Services", value: $services, inline: true},
                    {name: "Commit", value: $commit, inline: true},
                    {name: "Actor", value: $actor, inline: true}
                  ],
                  url: $url
                }
              ]
            }' > payload.json

          curl -sS -X POST "$DISCORD_WEBHOOK" \
            -H "Content-Type: application/json" \
            --data @payload.json
